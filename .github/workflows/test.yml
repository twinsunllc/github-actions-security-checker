name: Test Action

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-pass:
    name: Test with Secure Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      
      - name: Run Security Audit
        id: audit
        uses: ./
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Pass
        run: |
          if [ "${{ steps.audit.outputs.exit_code }}" != "0" ]; then
            echo "âŒ Expected audit to pass but it failed"
            exit 1
          fi
          echo "âœ… Audit passed as expected"

  test-fail:
    name: Test with Insecure Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Create test workflow with issues
        run: |
          mkdir -p .github/workflows
          cat > .github/workflows/insecure.yml << 'EOF'
          name: Insecure Workflow
          on: push
          jobs:
            test:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4  # Not pinned to hash
                - uses: unverified-publisher/action@v1  # Unverified publisher
                - uses: aws-action/configure-credentials@v1  # Typo in action name
          EOF
      
      - name: Run Security Audit
        id: audit
        uses: ./
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Fail
        run: |
          if [ "${{ steps.audit.outputs.exit_code }}" == "0" ]; then
            echo "âŒ Expected audit to fail but it passed"
            exit 1
          fi
          echo "âœ… Audit failed as expected"
      
      - name: Check Report
        run: |
          echo "ðŸ“‹ Audit Report:"
          cat action-security-report.md

  test-custom-dir:
    name: Test Custom Directory
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Create custom workflows directory
        run: |
          mkdir -p custom/workflows
          # Copy the actual action.yml file into the custom directory
          cp action.yml custom/workflows/action.yml
      
      - name: Run Security Audit
        id: audit
        uses: ./
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflows_dir: custom/workflows
      
      - name: Verify Custom Directory
        run: |
          if [ "${{ steps.audit.outputs.exit_code }}" != "0" ]; then
            echo "âŒ Custom directory test failed"
            exit 1
          fi
          echo "âœ… Custom directory test passed"